<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Generated by eggdoc Revision: 1.20  -->
<html>
<head>
<title>Eggs Unlimited - sendfile</title><style type="text/css">
<!--
       CODE {
             color: #666666;
           }
 /*   DT.definition EM { font-weight: bold; font-style: normal; } */
;      DT.definition { 
                    background: #eee;
                   color: black;
                   padding: 0.2em 1em 0.2em 0.7em;
                   margin-left: 0.2em;
border: 1px solid #bbc;
                   font-family: "Andale Mono", monospace;
                   /* font-size: 1.2em; */
                   
                 }
     DD {
                   margin-top: 0.8em;
                   margin-bottom: 0.8em;
     }
     DIV.subsection {
                    border-top: 1px solid #448;
                    padding-left: 1em;
                    margin-bottom: 1.2em;
     }
     DIV.subsubsection {
                    border-top: 1px dotted #99c;
                    /* border-left: 1px solid #99c; */
                    padding-left: 1em;
                    margin-bottom: 1.2em;
     }
     DIV.subsubsubsection {
                    border-top: 1px solid #ddf;
                    padding-left: 1em;
                    margin-bottom: 1.2em;
     }

	 DIV.section {
		 margin-bottom: 1.5em;
	 }
	 a:link {
		 color: #336;
	 }
	 a:visited { color: #666; }
	 a:active  { color: #966; }
	 a:hover   { color: #669; }
	 body { margin: 0; padding: 0; background: #fff; color: #000; font: 9pt "Lucida Grande", "Verdana", sans-serif; }
	 H2 {
		 background: #336;
		 color: #fff;
		 padding-top: 0.5em;
		 padding-bottom: 0.5em;
		 padding-left: 16px;
		 margin: 0 0 1em 0;
	}
	UL LI {
		list-style: none;
	}
	TT {
		font-family: "Andale Mono", monospace;
		/* font-size: 1.2em; */
	}
	H3 {
		color: #113;
		margin-bottom: 0.5em;
	}
	H4, H5, H6 {
		color: #113;
		margin-bottom: 1.0em;
	}
	H5 {
		font-weight: normal;
                font-style: italic;
		font-size: 100%;
		margin-top: 1.2em;
	}
	H6 {
		font-weight: bold;
		font-size: 85%;
		margin-top: 1.2em;
	}
     DIV#eggheader {
         text-align: center;
		 float: right;
		 margin-right: 2em;
     }
     DIV#header IMG {
            /* display: block; margin-left: auto; margin-right: auto;  */
            /* float: right; */
            border: none;  /* firefox */
     }
     DIV#footer {
                background: #bbd;
                padding: 0.7em ;
                border-top: 1px solid #cce;
     }
     DIV#footer hr {
                display: none;
     }
     DIV#footer a {
                float: left;
     }
     DIV#revision-history {
         float: right;
     }
     
     DIV#body {
		 margin: 1em 1em 1em 16px;
	 }

     DIV#examples PRE {
       background: #eef;
       padding: 0.1em;
       border: 1px solid #aac;
     }
     PRE#license, DIV#examples PRE {
       padding: 0.5em;
     }
     DIV#examples PRE {
       /* font-size: 85%; */
     }
     PRE { font-family: "Andale Mono", monospace; }
     TABLE {
       background: #eef;
       padding: 0.2em;
       border: 1px solid #aac;
       border-collapse: collapse;
       width: 100%;
     }
     TABLE.symbol-table TD.symbol {
          width: 15em;
          font-family: "Andale Mono", monospace;
          /* font-size: 1.2em; */
     }
     TH {
       text-align: left;
       border-bottom: 1px solid #aac;
       padding: 0.25em 0.5em 0.25em 0.5em;
     } 
     TD { padding: 0.25em 0.5em 0.25em 0.5em; }
     --></style></head>
<body>
<div id="header">
<h2>sendfile</h2>
<div id="eggheader"><a href="index.html">
<img src="egg.jpg" alt="[Picture of an egg]" /></a></div></div>
<div id="body">
<div class="section">
<h3>Description</h3>faster filetransfer over the network</div>
<div class="section">
<h3>Author</h3>David Krentzlin</div>
<div class="section">
<h3>Version</h3>
<ul>
<li>1.7 Actually allow input ports for source; they still have to have an underlying file descriptor currently</li>
<li>1.6.3 Use c-pointer instead of treating the buffer as a string. Thanks to Felix</li>
<li>1.6.2 Flush output port before sending to ensure output is sent in order.</li>
<li>1.5.0 The 'force parameter has been removed from (sendfile), its a parameter now instead. Bugfix for the read-write-loop, that causes corrupted files to be sent.</li>
<li>1.4.3 MacOS X 10.5 support, fix of BSD &amp; default 'sendfile_implementation' argument order, better error information</li>
<li>1.3.0 make it compile on windows</li>
<li>1.2.0 allmost complete rewrite</li>
<li>1.1.0 Enhanced portability</li>
<li>1.0.0 Initial release</li></ul></div>
<div class="section">
<h3>Usage</h3><tt>(require-extension sendfile)</tt></div>
<div class="section">
<h3>Download</h3><a href="sendfile.egg">sendfile.egg</a></div>
<div class="section">
<h3>Documentation</h3>
<p>This extension provides a way to do filetransfers with zero-copy-semantics if applicable. It provides an interface to the sendfile syscall on
 systems that support it. On other systems it emulates it with the help of memory-mapped IO. Sendfile is very configurable and tries to do the best based
 on the actual file. See below to learn what it provides.</p>
<p>NOTE: theoretically read-write-loop and mmapped-io can be used for file-to-file-transfers, where sendfile can only be used for file-network-transfers.</p>
<div class="subsection">
<h4>sending a file. the main interface</h4>
<dl>
<dt class="definition"><strong>procedure:</strong> (sendfile source destination)</dt>
<dd>
<p>Tries to send the file identified by `source` to `destination` as fast as possible. Unless a specific technique is forced it will decide what method to use from the systems capabilities and the filesize.</p>
<p>source ... can be either a port to the inputfile or a filedescriptor of an already opened file.
<p>destination ... can be either a port to the outputfile (socket) or a filedescriptor (socketdesciptor) of an already opened file (socket).  When it is a port, any buffered output is flushed via {{flush-output}} prior to sending the file.</p></p></dd></dl></div>
<div class="subsection">
<h4>sending a file with the sendfile-syscall</h4>
<dl>
<dt class="definition"><strong>procedure:</strong> (sendfile:sendfile source destination len)</dt>
<dd>
<p>If it is available this is the interface to the sendfile-implementation of your operating system</p>
<p>source ... is the filedescriptor of an already opened file</p>
<p>destination ... is the filedescriptor of an already opened file (MUST be a socket)</p>
<p>len ... is the size of the file in bytes as e.g. retrieved by (file-size)</p>
<p>This procedure returns the amount of bytes successfully written.</p></dd></dl></div>
<div class="subsection">
<h4>sending a file with memory-mapped-io</h4>
<dl>
<dt class="definition"><strong>procedure:</strong> (sendfile:mmapped source destination len)</dt>
<dd>
<p>Sends a file by mapping it into the memory and do repeated writes.</p>
<p>source ... is the filedescriptor of an already opened file</p>
<p>destination ... is the filedescriptor of an already opened file (can be a socket)</p>
<p>len ... is the size of the file in bytes as e.g. retrieved by (file-size)</p>
<p>This procedure returns the amount of bytes successfully written.</p></dd></dl></div>
<div class="subsection">
<h4>sending a file with a read-write-loop</h4>
<dl>
<dt class="definition"><strong>procedure:</strong> (sendfile:read-write-loop source destination len)</dt>
<dd>
<p>Sends a file by performing repeated reads and writes.</p>
<p>source ... is the filedescriptor of an already opened file</p>
<p>destination ... is the filedescriptor of an already opened file (can be a socket)</p>
<p>len ... is the size of the file in bytes as e.g. retrieved by (file-size)</p>
<p>This procedure returns the amount of bytes successfully written.</p></dd></dl></div>
<div class="subsection">
<h4>test if sendfile is natively available</h4>
<dl>
<dt class="definition">sendfile:os-dep:sendfile-available?</dt>
<dd>
<p>Is set to #t if the sendfile-syscall is available and #f if not</p></dd></dl></div>
<div class="subsection">
<h4>test if mmap() is available</h4>
<dl>
<dt class="definition">sendfile:os-dep:mmap-available?</dt>
<dd>
<p>Is set to #t if the mmap() is available and #f if not</p></dd></dl></div>
<div class="subsection">
<h4>Parameters</h4>
<dl>
<dt class="definition"><strong>parameter:</strong> sendfile:read-write-buffer-size</dt>
<dd>
<p>The size of the buffer that is used in sendfile:read-write-loop</p></dd>
<dt class="definition"><strong>parameter:</strong> sendfile:force-implementation</dt>
<dd>
<p>Causes sendfile to allways use the transmission-method specified by this parameter.
             Possible values are 'sendfile,'mmapped,'read-write and 'nothing.
            It defaults to 'nothing, where (sendfile) will decide which method to use based on the system's capabilities and sendfile:implementation-selector</p></dd>
<dt class="definition"><strong>parameter:</strong> sendfile:implementation-selector</dt>
<dd>
<p>A one-argument procedure that gets the size of the file in question passed and is expected to return a procedure to use (either of sendfile:mmapped,sendfile:sendfile,sendfile:read-write-loop)</p></dd></dl></div>
<div class="section">
<h3>Examples</h3>
<div id="examples">
<pre>(use sendfile)

;;in all the examples
;;we use a generic procedure with-prepared-environment
;;which we assume provides us with the input and outputports
;;needed. Most of the time the output-port will be a socket
;;and the input-port may be connected to a file
;;the size of the input-file was gathered as well


;; use the standard interface and let the system decide what to do
(with-prepared-environment
 (lambda (in out len)
   (sendfile in out)))

;; force a specific method to use: Part I

;;read-write
;;notice that you can force a specific transmission method
;;via the srfi parameter sendfile:force-implementation
;;there are four possible values: 'sendfile,'read-write-loop,'mmapped,'nothing
;;'nothing is the default, if this is set, sendfile will decide which implementation to use
;;based on the systems capabilities and the filesize
(with-prepared-environment
 (lambda (in out len)
   (parameterize ((sendfile:force-implementation 'read-write))
     (sendfile in out))))

;;force a specific method to use: Part II

;;sometimes you may want to decide which method to
;;use based on the size of the file.
;;there is an srfi-parameter called sendfile:implementation-selector
;;which does just that. See documentation for details
(with-prepared-environment
 (lambda (in out)
   (paramaterize ((sendfile:implementation-selector) (lambda (len)
                                                       (if (&gt; len 1024)
                                                           sendfile:sendfile
                                                           sendfile:read-write-loop)))
                 (sendfile in out))))
</pre></div></div></div></div>
<div id="footer">
<hr /><a href="index.html">&lt; Egg index</a>
<div id="revision-history">$Revision$ $Date$</div>&nbsp;</div></body></html>